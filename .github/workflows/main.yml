name: "main"

on: workflow_dispatch

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest"
          - platform: "ubuntu-22.04"
          - platform: "ubuntu-22.04-arm"
          - platform: "windows-latest"

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      # ----------------------------
      # macOS / Windows only setup
      # ----------------------------
      - name: setup uv (macOS/Windows only)
        if: matrix.platform != 'ubuntu-22.04' && matrix.platform != 'ubuntu-22.04-arm'
        uses: astral-sh/setup-uv@v6

      - name: Install python (macOS/Windows only)
        if: matrix.platform != 'ubuntu-22.04' && matrix.platform != 'ubuntu-22.04-arm'
        run: uv python install

      - name: setup node (macOS/Windows only)
        if: matrix.platform != 'ubuntu-22.04' && matrix.platform != 'ubuntu-22.04-arm'
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: install pnpm
        if: matrix.platform != 'ubuntu-22.04' && matrix.platform != 'ubuntu-22.04-arm'
        uses: pnpm/action-setup@v4.1.0
        with:
          version: latest

      - name: install Rust
        if: matrix.platform != 'ubuntu-22.04' && matrix.platform != 'ubuntu-22.04-arm'
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        if: matrix.platform != 'ubuntu-22.04' && matrix.platform != 'ubuntu-22.04-arm'
        uses: swatinem/rust-cache@v2

      # ----------------------------
      # macOS frontend & build
      # ----------------------------
      - name: install frontend deps and build the app (macOS)
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          cd GUI
          pnpm install
          cd ..
          uv run build.py

      # ----------------------------
      # Windows build
      # ----------------------------
      - name: install deps and build the app (Windows)
        if: matrix.platform == 'windows-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          $env:Path = "$env:USERPROFILE\.cargo\bin;$env:Path"
          cd GUI
          pnpm install
          cd ..
          uv run build.py

      # ----------------------------
      # Linux builds via Docker
      # ----------------------------
      - name: Build using Docker (Ubuntu / ARM)
        if: matrix.platform == 'ubuntu-22.04' || matrix.platform == 'ubuntu-22.04-arm'
        run: |
          echo "${{secrets.TAURI_SIGNING_PRIVATE_KEY}}" > tauri_signing_key.pem
          DOCKER_BUILDKIT=1 docker build \
            --secret id=tauri_key,src=tauri_signing_key.pem \
            -t ninja:latest .

          mkdir -p dist

          docker run --rm \
            -v "$(pwd)/dist:/dist" \
            ninja:latest bash -c "cp -r /build/dist/* /dist"

      # ----------------------------
      # Upload artifacts
      # ----------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: dist/

  # ======================================================================
  # Release job
  # ======================================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - run: mkdir artifacts

      - name: setup uv (macOS/Windows only)
        uses: astral-sh/setup-uv@v6

      - name: Install python (macOS/Windows only)
        run: uv python install

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # -------------------------------------------------
      # Extract version from ninja/core/Cargo.toml
      # -------------------------------------------------
      - name: Read Ninja version
        id: version
        run: |
          VERSION=$(grep 'package.version =' Cargo.toml | sed -E 's/package.version = "(.*)"/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
      - name: Generate latest.json
        run: |
          uv run version.py
      # -------------------------------------------------
      # Build release body (signatures)
      # -------------------------------------------------
      - name: Collect signatures for release body
        run: |
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "### Digital Signatures"
          echo ""

          find artifacts -type f -name "*.sig" | sort | while read sigfile; do
            base=$(basename "$sigfile")
            echo "#### $base"
            echo '```'
            cat "$sigfile"
            echo '```'
            echo ""
          done

          echo "All signatures generated automatically during CI."
          echo "EOF" >> $GITHUB_ENV

      # -------------------------------------------------
      # Create GitHub Release
      # -------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "Ninja ${{ env.VERSION }}"
          body: ${{ env.RELEASE_BODY }}
          files: |
            artifacts/**/Ninja*.exe
            artifacts/**/Ninja*.msi
            artifacts/**/Ninja*.zip
            artifacts/**/Ninja*.dmg
            artifacts/**/Ninja*.deb
            artifacts/**/Ninja*.rpm
            artifacts/**/Ninja*.tar.gz
            artifacts/**/*.sig
            **/latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
